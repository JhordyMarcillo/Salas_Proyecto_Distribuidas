<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Cliente prueba — Salas / Acceso Anónimo / Multimedia</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 18px; background:#f6f8fa; color:#111; }
    .container { max-width: 1100px; margin: 0 auto; background: white; padding: 18px; border-radius: 8px; box-shadow: 0 6px 20px rgba(0,0,0,0.06); }
    h1 { margin: 0 0 12px 0; font-size: 20px; }
    .row { display:flex; gap:12px; margin-bottom:10px; align-items:center; flex-wrap:wrap; }
    input, button, select, textarea { padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; }
    button { cursor:pointer; background:#0b5fff; color:white; border:none; }
    button.secondary { background:#6b7280; }
    .token { font-family: monospace; background:#f3f4f6; padding:6px; border-radius:6px; }
    #log { height:320px; background:#0b1220; color:#e6eef8; padding:12px; overflow:auto; border-radius:6px; font-family: monospace; font-size:13px; }
    .status { padding:6px 8px; border-radius:6px; display:inline-block; margin-left:6px; font-weight:600; }
    .connected { background:#dcfce7; color:#065f46; }
    .disconnected { background:#fee2e2; color:#991b1b; }
    .panel { border:1px solid #e6e9ee; padding:12px; border-radius:8px; background:#fff; }
    #roomsList { max-height:220px; overflow:auto; border:1px solid #eef2f7; padding:8px; border-radius:6px; background:#fbfdff; }
    .roomItem { padding:8px; border-bottom:1px dashed #e6eef8; cursor:pointer; }
    .roomItem:last-child { border-bottom: none; }
    .meta { font-size:12px; color:#6b7280; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Cliente prueba — Salas / Acceso Anónimo / Multimedia</h1>

    <div class="row">
      <label>Server URL</label>
      <input id="serverUrl" value="http://localhost:5000" style="flex:1;" />
      <button id="btnConnect">Conectar</button>
      <button id="btnDisconnect" class="secondary">Desconectar</button>
      <div id="connStatus" class="status disconnected">Desconectado</div>
    </div>

    <hr/>

    <div style="display:flex;gap:12px;flex-wrap:wrap;">
      <div style="flex:1;min-width:280px;">
        <div class="panel">
          <h3>Registro / Login</h3>
          <div class="row">
            <input id="regUser" placeholder="usuario" />
            <input id="regPass" placeholder="contraseña" type="password" />
            <button id="btnRegister">Registrar</button>
          </div>
          <div class="row">
            <input id="logUser" placeholder="usuario" />
            <input id="logPass" placeholder="contraseña" type="password" />
            <button id="btnLogin">Login</button>
          </div>
          <div class="row small">
            <label>Token actual:</label>
            <div id="tokenBox" class="token">ninguno</div>
            <button id="btnClearToken" class="secondary">Borrar</button>
          </div>
          <div class="row small">
            <label><input type="checkbox" id="useHandshake" /> Usar token en handshake</label>
          </div>
        </div>
      </div>

      <div style="flex:1.6;min-width:380px;">
        <div class="panel">
          <!-- Sección de creación de salas removida. --->
          <h3>Salas disponibles</h3>
          <div class="row">
            <div style="flex:1;">
              <div id="roomsList"></div>
              <div class="row" style="margin-top:8px;">
                <button id="btnRefreshRooms" class="secondary">Refrescar Lista</button>
                <div class="small" style="margin-left:8px;">Haz clic en fila para rellenar ID/nombre</div>
              </div>
            </div>

            <div style="width:340px;">
              <h4>Unirse</h4>
              <div class="row">
                <input id="roomName" placeholder="Unirse por nombre (autenticado)" style="flex:1;" />
                <button id="btnJoinByName">Unirse (nombre)</button>
              </div>
              <div class="row">
                <input id="roomId" placeholder="room_id" style="flex:1;" />
                <input id="roomPin" placeholder="PIN" style="width:100px;" />
              </div>
              <div class="row">
                <input id="nickAnon" placeholder="nickname (anónimo)" style="flex:1;" />
                <button id="btnJoinById">Unirse (anónimo)</button>
              </div>
              <div class="row small">
                <label>Usuario conectado en sala: </label>
                <div id="currentRoom" class="token">ninguna</div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div style="flex:1;min-width:260px;">
        <div class="panel">
          <h3>Mensajes / Subida</h3>
          <div class="row">
            <input id="msgText" placeholder="mensaje..." style="flex:1;" />
            <button id="btnSend">Enviar</button>
          </div>

          <div class="row">
            <input type="file" id="fileInput" />
            <button id="btnUpload" class="secondary">Subir archivo</button>
          </div>

          <div class="row small">
            <label>Última URL subida:</label>
            <div id="lastFileUrl" class="token">-</div>
          </div>

          <div class="row">
            <button id="btnLeave" class="secondary">Salir de sala</button>
            <button id="btnClearLog" class="secondary">Limpiar Log</button>
          </div>
        </div>
      </div>
    </div>

    <hr/>
    <h3>Log / Mensajes</h3>
    <div id="log"></div>
  </div>

  <script>
    let socket = null;
    let jwtToken = null;
    let currentRoom = null;
    let currentUsername = null; 
    
    const $ = id => document.getElementById(id);
    const logEl = $('log');

    function log(...args){
      logEl.textContent += new Date().toLocaleTimeString() + " " + args.join(" ") + "\n";
      logEl.scrollTop = logEl.scrollHeight;
      console.log(...args);
    }

    function setConnState(state){
      const el = $('connStatus');
      if(state === 'connected'){ el.textContent='Conectado'; el.className='status connected'; }
      else{ el.textContent='Desconectado'; el.className='status disconnected'; }
    }

    function setToken(t){
      jwtToken = t;
      $('tokenBox').textContent = t || 'ninguno';
      if (t) localStorage.setItem('chat_token', t); else localStorage.removeItem('chat_token');
    }

    function setCurrentRoom(r){
      currentRoom = r;
      $('currentRoom').textContent = r || 'ninguna';
    }

    function makeSocket(auth){
      if(socket){ try{ socket.disconnect(); } catch(e){} socket=null; }
      const url = $('serverUrl').value.trim() || 'http://localhost:5000';
      socket = io(url, { transports: ["websocket","polling"], auth: auth || {}, autoConnect: true });
      socket.on('connect', ()=>{ setConnState('connected'); log('[connect] id', socket.id); });
      socket.on('disconnect', (r)=>{ setConnState('disconnected'); log('[disconnect]', r); setCurrentRoom(null); currentUsername = null; });
      socket.on('status', d=> log('[status]', d.msg || d));
      socket.on('register_success', d=>{ log('[register_success]', d); if(d.token) setToken(d.token); });
      socket.on('login_success', d=>{ log('[login_success]', d); if(d.token) setToken(d.token); });
      socket.on('join_success', d=>{ log('[join_success]', d); if(d.room) setCurrentRoom(d.room); if(d.username) currentUsername = d.username; if(d.nickname) log('[info] nickname', d.nickname); });
      socket.on('join_error', d=> log('[join_error]', d));
      socket.on('leave_success', d=>{ log('[leave_success]', d); if(d.room === currentRoom) setCurrentRoom(null); currentUsername = null; });
      socket.on('message', d=> {
        const who = d.nickname || d.username;
        let line = `[message] [${d.room}] ${who}: ${d.msg || ''}`;
        if(d.file_url) line += ` [file] ${d.file_url} (${d.original_filename || ''})`;
        log(line);
      });
      socket.on('user_joined', d => { log('[user_joined]', d.nickname||d.username, '->', d.room); });
      socket.on('user_left', d => { log('[user_left]', d.nickname||d.username, '<-', d.room); });
      socket.on('user_disconnected', d => { log('[user_disconnected]', d.nickname||d.username, JSON.stringify(d)); });
      socket.on('error', d=> log('[error]', d));
    }

    async function apiFetch(path, opts = {}) {
      const base = $('serverUrl').value.trim() || 'http://localhost:5000';
      const url = base.replace(/\/$/, '') + path;
      try {
        if(!opts.headers) opts.headers = {};
        if(jwtToken) opts.headers['Authorization'] = 'Bearer ' + jwtToken;
        const res = await fetch(url, opts);
        const text = await res.text();
        let json = null;
        try{ json = JSON.parse(text); } catch(e){}
        return { ok: res.ok, status: res.status, data: json, raw: text };
      } catch(err){
        return { ok: false, error: err };
      }
    }

    async function loadRooms(){
      const r = await apiFetch('/rooms');
      if(!r.ok){ log('[rooms] error', r); return; }
      const list = r.data && r.data.rooms ? r.data.rooms : [];
      const c = $('roomsList'); c.innerHTML = '';
      if(list.length === 0) { c.textContent = 'No hay salas'; return; }
      list.forEach(room=>{
        const el = document.createElement('div');
        el.className = 'roomItem';
        el.innerHTML = `<div style="font-weight:600">${room.name} <span class="meta">(#${room.id})</span></div>
                        <div class="meta">${room.description || ''} • tipo: ${room.type} • miembros: ${room.members}</div>`;
        el.addEventListener('click', ()=>{
          const roomIdInput = $('roomId'); if(roomIdInput) roomIdInput.value = room.id;
          const roomNameInput = $('roomName'); if(roomNameInput) roomNameInput.value = room.name;
          const roomPinInput = $('roomPin'); if(roomPinInput) roomPinInput.value = '';
          const nickInput = $('nickAnon'); if(nickInput) nickInput.value = '';
          log('[rooms] seleccionado', room.name, room.id);
        });
        c.appendChild(el);
      });
    }

    async function createRoom(){
      const name = $('newRoomName') ? $('newRoomName').value.trim() : null;
      const desc = $('newRoomDesc') ? $('newRoomDesc').value.trim() : '';
      const type = $('newRoomType') ? $('newRoomType').value : 'text';
      const pin = $('newRoomPin') ? $('newRoomPin').value.trim() : '';
      const max_mb = $('newRoomMax') ? $('newRoomMax').value.trim() : '';

      if(!name) return alert('name requerido');
      const payload = { name, description: desc, type };
      if(pin) payload.pin = pin;
      if(max_mb) payload.max_file_mb = parseInt(max_mb);

      const r = await apiFetch('/rooms', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if(!r.ok){
        alert('Error creando sala: ' + (r.data && r.data.msg ? r.data.msg : r.status));
        log('[create_room] error', r);
        return;
      }
      const createdBox = $('createdRoomInfo');
      if(createdBox) createdBox.textContent = JSON.stringify(r.data.room);
      log('[create_room] creada', r.data.room);
      loadRooms();
    }

    async function uploadFile() {
      const fileInput = $('fileInput');
      if(!fileInput.files || fileInput.files.length === 0) return alert('Selecciona archivo');
      const file = fileInput.files[0];
      const base = $('serverUrl').value.replace(/\/$/, '');
      const form = new FormData();
      form.append('file', file);

      if(currentUsername) form.append('username', currentUsername);
      try {
        const res = await fetch(base + '/upload', { method: 'POST', body: form });
        const json = await res.json().catch(()=>null);
        if(!res.ok){ alert('Error upload: ' + (json && json.msg ? json.msg : res.status)); log('[upload] error', json); return; }
        const url = json.url;
        $('lastFileUrl').textContent = url;
        log('[upload] OK', url);
        return { url, filename: json.filename };
      } catch(e){ log('[upload] exception', e); alert('Error upload: ' + e.message); }
    }

    if ($('btnConnect')) {
      $('btnConnect').addEventListener('click', ()=>{
        const useHandshake = $('useHandshake') ? $('useHandshake').checked : false;
        if(useHandshake && jwtToken) makeSocket({ token: jwtToken }); else makeSocket({});
      });
    }
    if ($('btnDisconnect')) $('btnDisconnect').addEventListener('click', ()=>{ if(socket) socket.disconnect(); });

    if ($('btnRegister')) $('btnRegister').addEventListener('click', ()=>{ const u=$('regUser').value.trim(), p=$('regPass').value; if(!u||!p) return alert('username & pass'); if(!socket||!socket.connected){ log('Conecta primero'); return } socket.emit('register',{username:u,password:p}); });
    if ($('btnLogin')) $('btnLogin').addEventListener('click', ()=>{ const u=$('logUser').value.trim(), p=$('logPass').value; if(!u||!p) return alert('username & pass'); if(!socket||!socket.connected){ log('Conecta primero'); return } socket.emit('login',{username:u,password:p}); });

    if ($('btnCreateRoom')) $('btnCreateRoom').addEventListener('click', createRoom);
    if ($('btnRefreshRooms')) $('btnRefreshRooms').addEventListener('click', loadRooms);

    if ($('btnJoinByName')) $('btnJoinByName').addEventListener('click', ()=>{ const name = $('roomName').value.trim(); if(!name) return alert('room requerido'); if(!socket||!socket.connected) return alert('Conecta primero'); if(!jwtToken) return alert('Necesitas token (login) para unirte por nombre'); socket.emit('join', { token: jwtToken, room: name }); log('[emit] join (name)', name); });

    if ($('btnJoinById')) $('btnJoinById').addEventListener('click', async ()=>{ const room_id = $('roomId').value.trim(); const pin = $('roomPin').value.trim(); const nickname = $('nickAnon').value.trim(); if(!room_id || !pin || !nickname) return alert('room_id, pin y nickname requeridos'); if(!socket||!socket.connected) return alert('Conecta primero'); socket.emit('join', { room_id, pin, nickname }); log('[emit] join anon', room_id, nickname); });

    if ($('btnLeave')) $('btnLeave').addEventListener('click', ()=>{ const room = currentRoom || ($('roomName')?$('roomName').value.trim():''); if(!room) return alert('Room requerido'); if(!socket||!socket.connected) return alert('Conecta primero'); const payload = { room }; if(jwtToken) payload.token = jwtToken; socket.emit('leave', payload); log('[emit] leave', room); });

    if ($('btnSend')) $('btnSend').addEventListener('click', async ()=>{ const room = currentRoom || ($('roomName')?$('roomName').value.trim():''); const msg = $('msgText').value.trim(); if(!room) return alert('Estás fuera de sala'); if(!socket||!socket.connected) return alert('Conecta primero'); let file_url = null; let original_filename = null; if($('fileInput') && $('fileInput').files && $('fileInput').files.length > 0){ const up = await uploadFile(); if(!up) return; file_url = up.url; original_filename = up.filename; } const payload = { room, msg }; if(file_url){ payload.file_url = file_url; payload.original_filename = original_filename; } if(jwtToken) payload.token = jwtToken; socket.emit('send_message', payload); log('[emit] send_message', msg || '(archivo)'); $('msgText').value = ''; if($('fileInput')) $('fileInput').value = ''; $('lastFileUrl').textContent = '-'; });

    if ($('btnUpload')) $('btnUpload').addEventListener('click', async ()=>{ const up = await uploadFile(); if(up){ $('lastFileUrl').textContent = up.url; } });

    if ($('btnClearLog')) $('btnClearLog').addEventListener('click', ()=>{ logEl.textContent = ''; });
    if ($('btnClearToken')) $('btnClearToken').addEventListener('click', ()=>{ setToken(null); });

    const stored = localStorage.getItem('chat_token');
    if(stored) setToken(stored);

    setConnState('disconnected');
    loadRooms();

  </script>
</body>
</html>
